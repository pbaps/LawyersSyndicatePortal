@model IEnumerable<LawyersSyndicatePortal.Models.Question>
@{
    // تعيين عنوان الصفحة والربط بملف الستايل المشترك
    ViewBag.Title = "إدارة أسئلة الاختبار";

}

<!-- ربط بملف الستايل المشترك -->
<link href="@Url.Content("~/Content/Examstylenew.css")" rel="stylesheet" type="text/css" />

<div class="container  ">
    <div class="row">
        <div class="col-md-12 text-right mb-4">
            <h2>أسئلة الاختبار: @ViewBag.ExamTitle</h2>
        </div>
    </div>

    <!-- رسائل التنبيه (رسائل النجاح أو الخطأ) -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert" dir="rtl">
            @TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert" dir="rtl">
            @TempData["ErrorMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <!-- أزرار الإجراءات الرئيسية (إضافة، تصدير، تنزيل) -->
    <div class="row mb-3">
        <div class="col-md-12 d-flex justify-content-end">
            <a href="@Url.Action("Create", new { examId = ViewBag.ExamId })" class="btn btn-primary ml-2">
                <i class="fas fa-plus"></i> إضافة سؤال جديد
            </a>
            <a href="@Url.Action("ExportToExcel", new { examId = ViewBag.ExamId })" class="btn btn-success ml-2">
                <i class="fas fa-file-excel"></i> تصدير إلى Excel
            </a>
            <a href="@Url.Action("DownloadImportTemplate")" class="btn btn-info">
                <i class="fas fa-download"></i> تنزيل نموذج الاستيراد
            </a>
        </div>
    </div>

    <!-- نموذج الاستيراد -->
    <div class="card mb-4" dir="rtl">
        <div class="card-header bg-dark text-white">
            <h4>استيراد أسئلة من Excel</h4>
        </div>
        <div class="card-body">
            @using (Html.BeginForm("ImportFromExcel", "ExamQuestions", FormMethod.Post, new { enctype = "multipart/form-data" }))
            {
                @Html.AntiForgeryToken()
                @Html.Hidden("examId", (int)ViewBag.ExamId)

                <div class="form-group row">
                    <label class="col-sm-2 col-form-label">الملف</label>
                    <div class="col-sm-6">
                        <div class="custom-file">
                            <input type="file" name="file" id="file" class="custom-file-input" required />
                            <label class="custom-file-label" for="file">اختر ملف Excel...</label>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload"></i> استيراد
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- جدول عرض الأسئلة -->
    <table class="table table-striped table-bordered text-right" dir="rtl">
        <thead class="thead-dark">
            <tr>
                <th style="width: 40%;">نص السؤال</th>
                <th style="width: 15%;">نوع السؤال</th>
                <th style="width: 10%;">الدرجة</th>
                <th style="width: 10%;">يحتاج تصحيح يدوي</th>
                <th style="width: 10%;">مدة السؤال</th>
                <th style="width: 15%;">الإجراءات</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Any())
            {
                foreach (var question in Model)
                {
                    <tr class="table-row-question">
                        <td>@Html.Raw(question.Text)</td>
                        <td>@GetQuestionTypeString(question.QuestionType)</td>
                        <td>@question.Score</td>
                        <td>
                            @if (question.RequiresManualGrading)
                            {
                                <span class="badge badge-success">نعم</span>
                            }
                            else
                            {
                                <span class="badge badge-danger">لا</span>
                            }
                        </td>
                        <td>
                            @if (question.DurationSeconds.HasValue)
                            {
                                @question.DurationSeconds.Value
                            }
                            else
                            {
                                <span>غير محدد</span>
                            }
                        </td>
                        <td>
                            <a href="@Url.Action("Edit", new { id = question.Id })" class="btn btn-sm btn-warning">
                                <i class="fas fa-edit"></i> تعديل
                            </a>
                            <a href="@Url.Action("Delete", new { id = question.Id })" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash-alt"></i> حذف
                            </a>
                        </td>
                    </tr>
                    @* تم إزالة @ من أمام if لأننا بالفعل داخل كتلة برمجية (حلقة foreach) *@
                    if (question.Options != null && question.Options.Any())
                    {
                        <tr>
                            <td colspan="6">
                                <div class="options-list">
                                    <p class="font-weight-bold mb-1">الخيارات:</p>
                                    <ul class="list-group list-group-flush">
                                        @foreach (var option in question.Options)
                                        {
                                            <li class="list-group-item">
                                                <i class="fas fa-circle mr-2" style="color: @(option.IsCorrect ? "green" : "red")"></i>
                                                @option.Text
                                                @if (option.IsCorrect)
                                                {
                                                    <span class="badge badge-success badge-pill float-left">إجابة صحيحة</span>
                                                }
                                            </li>
                                        }
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    }
                }
            }
            else
            {
                <tr>
                    <td colspan="6" class="text-center">لا توجد أسئلة لهذا الاختبار بعد.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Scripts for file input label update -->
@section scripts {
    <script>
        document.querySelector('.custom-file-input').addEventListener('change', function (e) {
            var fileName = e.target.files[0].name;
            var nextSibling = e.target.nextElementSibling;
            nextSibling.innerText = fileName;
        });
    </script>
}

@functions {
    // دالة مساعدة لعرض نوع السؤال
    public string GetQuestionTypeString(LawyersSyndicatePortal.Models.QuestionType type)
    {
        switch (type)
        {
            case LawyersSyndicatePortal.Models.QuestionType.MultipleChoice:
                return "خيار متعدد";
            case LawyersSyndicatePortal.Models.QuestionType.TextAnswer:
                return "إجابة نصية";
            default:
                return "غير محدد";
        }
    }
}
