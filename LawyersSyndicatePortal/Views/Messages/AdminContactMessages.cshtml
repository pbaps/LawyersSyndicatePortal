@model LawyersSyndicatePortal.ViewModels.AdminMessageListViewModel

@{
    ViewBag.Title = "رسائل الاتصال الواردة";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    /* أنماط مخصصة لجدول المستخدمين (تم نسخها وتطبيقها هنا) */
    body {
        background-color: #f8f9fa;
    }

    .container {
        padding-top: 30px;
        padding-bottom: 30px;
    }

    .table-responsive {
        margin-top: 20px;
        border-radius: 0.5rem; /* حواف مستديرة */
        overflow: hidden; /* يضمن أن المحتوى يحترم الحواف المستديرة */
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); /* ظل خفيف */
    }

    .table thead th {
        background-color: #e9ecef; /* لون خلفية لرأس الجدول */
        font-weight: bold;
        color: #343a40;
        text-align: right; /* محاذاة النص لليمين لرؤوس الأعمدة */
        vertical-align: middle;
        padding: 0.75rem 1.25rem;
        border-bottom: 2px solid #dee2e6;
    }

    .table tbody td {
        vertical-align: middle;
        text-align: right; /* محاذاة النص لليمين لخلايا البيانات */
        padding: 0.75rem 1.25rem;
    }

    .table-hover tbody tr:hover {
        background-color: #f1f1f1;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0,0,0,.02); /* لون أفتح قليلاً للأسطر الفردية */
    }

    /* الأنماط الجديدة للأزرار الدائرية */
    .table tbody td .btn.rounded-circle {
        width: 36px; /* عرض ثابت للأزرار الدائرية */
        height: 36px; /* ارتفاع ثابت للأزرار الدائرية */
        padding: 0; /* إزالة الحشوة الافتراضية */
        display: inline-flex; /* لجعل المحتوى يتركز عمودياً وأفقياً */
        align-items: center; /* لمحاذاة الأيقونة عمودياً */
        justify-content: center; /* لمحاذاة الأيقونة أفقياً */
        text-decoration: none; /* إزالة التسطير من الروابط */
        margin-left: 5px; /* مسافة بين الأزرار */
        margin-bottom: 5px; /* هامش سفلي للأزرار في الخلايا */
    }

    /* تحسين زر الإغلاق في التنبيهات لـ Bootstrap 5 */
    .alert .btn-close {
        padding: 0.5rem 0.5rem;
        margin: -0.375rem -0.375rem -0.375rem auto;
    }

    /* لضمان ظهور الأيقونات بشكل صحيح */
    .btn-link .fas {
        margin-right: 5px; /* مسافة بين الأيقونة والنص */
    }

    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        flex-wrap: wrap;
        padding: 10px 0;
    }

    .pagination {
        flex-wrap: wrap;
        justify-content: flex-start; /* يمكنك تغييرها إلى flex-end أو center */
    }
</style>

<h2 class="text-center mb-4">رسائل الاتصال الواردة</h2>

@* رسائل النجاح/الخطأ من TempData *@
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@using (Html.BeginForm("AdminContactMessages", "Messages", FormMethod.Get, new { @class = "mb-4" }))
{
<div class="row g-3 align-items-center">
    <div class="col-md-4">
        <label for="searchString" class="form-label">بحث:</label>
        @Html.TextBoxFor(model => model.SearchString, new { @class = "form-control", placeholder = "بحث بالاسم، البريد، الموضوع، أو نص الرسالة" })
    </div>
    <div class="col-md-3">
        <label for="isReadFilter" class="form-label">حالة القراءة:</label>
        @Html.DropDownListFor(model => model.IsReadFilter, new List<SelectListItem>
        {
            new SelectListItem { Value = "", Text = "الكل" },
            new SelectListItem { Value = "false", Text = "غير مقروءة" },
            new SelectListItem { Value = "true", Text = "مقروءة" }
        }, new { @class = "form-select" })
    </div>
    @*   <div class="col-md-3">
            <label for="isRepliedFilter" class="form-label">حالة الرد:</label>
            @Html.DropDownList("IsRepliedFilter", new List<SelectListItem>
            {
                new SelectListItem { Value = "", Text = "الكل" },
                new SelectListItem { Value = "false", Text = "لا" },
                new SelectListItem { Value = "true", Text = "نعم" }
            }, new { @class = "form-select" })
        </div>*@
    <div class="col-md-3">
        <label for="isRepliedFilter" class="form-label">حالة الرد:</label>
        @Html.DropDownList("IsRepliedFilter", new List<SelectListItem>
        {
            new SelectListItem { Value = "", Text = "الكل", Selected = !Model.IsRepliedFilter.HasValue },
            new SelectListItem { Value = "true", Text = "نعم", Selected = Model.IsRepliedFilter.HasValue && Model.IsRepliedFilter.Value },
            new SelectListItem { Value = "false", Text = "لا", Selected = Model.IsRepliedFilter.HasValue && !Model.IsRepliedFilter.Value }
        }, new { @class = "form-select" })
    </div>
    <div class="col-md-2">
        <label for="pageSize" class="form-label">عرض:</label>
        @Html.DropDownListFor(model => model.PageSize, Model.PageSizes, new { @class = "form-select" })
    </div>
    <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">
            <i class="fas fa-filter me-1"></i> تصفية
        </button>
        <a href="@Url.Action("AdminContactMessages", "Messages")" class="btn btn-secondary">
            <i class="fas fa-sync-alt me-1"></i> إعادة تعيين
        </a>
    </div>
</div>
}

@if (Model.Messages.Any())
{
    <div class="table-responsive">
        <table class="table table-hover table-striped table-bordered rounded-3 overflow-hidden">
            <thead class="table-primary">
                <tr>
                    <th>الاسم الكامل</th>
                    <th>البريد الإلكتروني</th>
                    <th>الموضوع</th>
                    <th>تاريخ الإرسال</th>
                    <th>مقروءة</th>
                    <th>تم الرد</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Messages)
                {
                    <tr class="@(item.IsRead ? "" : "table-warning fw-bold")">
                        <td>@Html.DisplayFor(modelItem => item.FullName)</td>
                        <td>@Html.DisplayFor(modelItem => item.Email)</td>
                        <td>@Html.DisplayFor(modelItem => item.Subject)</td>
                        <td>@Html.DisplayFor(modelItem => item.SentDate)</td>
                        <td>
                            @if (item.IsRead)
                            {
                                <span class="badge bg-success">نعم</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">لا</span>
                            }
                        </td>
                        <td>
                            @if (item.ReplyDate.HasValue)
                            {
                                <span class="badge bg-info">نعم (@item.ReplyDate.Value.ToString("yyyy-MM-dd HH:mm"))</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">لا</span>
                            }
                        </td>
                        <td>
                            @Html.ActionLink("التفاصيل", "AdminContactMessageDetails", "Messages", new { id = item.Id }, new { @class = "btn btn-info btn-sm me-1" })
                            @if (!item.IsRead)
                            {
                                <button type="button" class="btn btn-success btn-sm me-1" onclick="markAsRead(@item.Id)">
                                    <i class="fas fa-eye me-1"></i> مقروءة
                                </button>
                            }
                            else
                            {
                                <button type="button" class="btn btn-warning btn-sm me-1" onclick="markAsUnread(@item.Id)">
                                    <i class="fas fa-eye-slash me-1"></i> غير مقروءة
                                </button>
                            }
                            <button type="button" class="btn btn-danger btn-sm" onclick="deleteMessage(@item.Id)">
                                <i class="fas fa-trash me-1"></i>  
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @* Pagination (Updated to show page numbers) *@
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            @if (Model.CurrentPage > 1)
            {
                <li class="page-item">
                    @Html.ActionLink("السابق", "AdminContactMessages", "Messages", new { page = Model.CurrentPage - 1, pageSize = Model.PageSize, searchString = Model.SearchString, isReadFilter = Model.IsReadFilter }, new { @class = "page-link" })
                </li>
            }

            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                    @Html.ActionLink(i.ToString(), "AdminContactMessages", "Messages", new { page = i, pageSize = Model.PageSize, searchString = Model.SearchString, isReadFilter = Model.IsReadFilter }, new { @class = "page-link" })
                </li>
            }

            @if (Model.CurrentPage < Model.TotalPages)
            {
                <li class="page-item">
                    @Html.ActionLink("التالي", "AdminContactMessages", "Messages", new { page = Model.CurrentPage + 1, pageSize = Model.PageSize, searchString = Model.SearchString, isReadFilter = Model.IsReadFilter }, new { @class = "page-link" })
                </li>
            }
        </ul>
    </nav>
}
else
{
    <div class="alert alert-info text-center" role="alert">
        لا توجد رسائل اتصال لعرضها حالياً.
    </div>
}

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        // إغلاق التنبيهات تلقائيًا بعد 5 ثوانٍ
        $(document).ready(function () {
            window.setTimeout(function () {
                $(".alert").fadeTo(500, 0).slideUp(500, function () {
                    $(this).remove();
                });
            }, 5000); // 5 ثوانٍ
        });
        function markAsRead(id) {
            if (confirm('هل أنت متأكد أنك تريد وضع علامة "مقروءة" على هذه الرسالة؟')) {
                $.post('@Url.Action("MarkContactMessageAsRead", "Messages")', { id: id }, function (response) {
                    location.reload();
                });
            }
        }

        function markAsUnread(id) {
            if (confirm('هل أنت متأكد أنك تريد وضع علامة "غير مقروءة" على هذه الرسالة؟')) {
                $.post('@Url.Action("MarkContactMessageAsUnread", "Messages")', { id: id }, function (response) {
                    location.reload();
                });
            }
        }

        // تفعيل وظيفة حذف الرسالة
        function deleteMessage(id) {
            if (confirm('هل أنت متأكد أنك تريد حذف هذه الرسالة بشكل دائم؟')) {
                $.post('@Url.Action("DeleteContactMessage", "Messages")', { id: id }, function (response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert(response.message);
                    }
                });
            }
        }
    </script>
}