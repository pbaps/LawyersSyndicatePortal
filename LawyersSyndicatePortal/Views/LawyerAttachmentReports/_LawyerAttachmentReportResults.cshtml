@model LawyersSyndicatePortal.ViewModels.LawyerAttachmentReportResultViewModel
@using System.Linq
@using System.Reflection
@using LawyersSyndicatePortal.ViewModels

@*
    هذا هو الجزء (Partial View) المسؤول عن عرض نتائج التقرير في جدول.
    يتم تحديثه بشكل ديناميكي عبر AJAX.
*@

@if (Model != null && Model.Reports != null && Model.Reports.Any())
{
    @* الفرز الأبجدي حسب اسم المحامي *@
    <div class="table-responsive">
        <div class="report-table mt-4">
            <table class="table table-striped table-bordered table-responsive-md text-right" dir="rtl">
                <thead>
                    <tr>
                        @foreach (var column in Model.SelectedColumns)
                        {
                            <th>@column.DisplayName</th>
                        }
                        @* إضافة عمود جديد لـ "استعراض في المتصفح" بشكل ثابت *@
                        <th>استعراض في المتصفح</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var reportItem in Model.Reports.OrderBy(r => r.LawyerFullName))
                    {
                        <tr>
                            @foreach (var column in Model.SelectedColumns)
                            {
                                <td>
                                    @{
                                        // استخدم Reflection للحصول على قيمة الخاصية من الـ ReportItem
                                        var prop = typeof(LawyerAttachmentReportResultItem).GetProperty(column.ColumnName);
                                        if (prop != null)
                                        {
                                            object value = prop.GetValue(reportItem, null);
                                            if (value != null)
                                            {
                                                // معالجة خاصة لرابط المرفق (التنزيل/العرض المباشر)
                                                if (column.ColumnName == "FilePath")
                                                {
                                                    // بناء URL يشير إلى إجراء ViewAttachment في المتحكم
                                                    string fileUrl = Url.Action("ViewAttachment", "LawyerAttachmentReports", new { attachmentId = reportItem.Id });
                                                    <a href="@fileUrl" target="_blank">عرض المرفق</a>
                                                }
                                                // معالجة خاصة للقيم المنطقية (bool?) والتاريخ (DateTime?)
                                                else if (prop.PropertyType == typeof(bool?))
                                                {
                                                    bool? boolValue = (bool?)value;
                                                    @((boolValue.HasValue && boolValue.Value) ? "نعم" : "لا")
                                                }
                                                else if (prop.PropertyType == typeof(DateTime?))
                                                {
                                                    DateTime? dateValue = (DateTime?)value;
                                                    @(dateValue.HasValue ? dateValue.Value.ToShortDateString() : "غير متوفر")
                                                }
                                                else
                                                {
                                                    @value.ToString()
                                                }
                                            }
                                            else
                                            {
                                                @:غير متوفر
                                            }
                                        }
                                        else
                                        {
                                            @:غير متوفر
                                        }
                                    }
                                </td>
                            }
                            @* إضافة خلية للعمود الجديد "استعراض في المتصفح" *@
                            <td>
                                @{
                                    string browseUrl = Url.Action("DisplayAttachment", "LawyerAttachmentReports", new { attachmentId = reportItem.Id });
                                    <a href="@browseUrl" target="_blank">استعراض في المتصفح</a>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        </div>
        }
        else
        {
        <div class="alert alert-info text-center mt-5" role="alert">
            <i class="fas fa-info-circle ml-2"></i> لا توجد نتائج مطابقة لمعايير البحث المحددة.
        </div>
        }
