@model LawyersSyndicatePortal.ViewModels.OfficeAndDamageReportViewModel
@using System.Web.Mvc.Html
@using System.Globalization
@using System.Linq
@using LawyersSyndicatePortal.ViewModels

@*
    المسار: LawyersSyndicatePortal/Views/OfficeAndDamageReports/Index.cshtml
    هذه الصفحة مسؤولة عن تقارير المكاتب وأضرارها وأضرار المنازل.
    تسمح للمسؤولين بالبحث ديناميكيًا واختيار الأعمدة وتصدير النتائج إلى Excel.
*@

@{
    ViewBag.Title = "تقارير المكاتب والأضرار";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    // قوائم بيانات افتراضية لملء قوائم الاختيار (Select Lists)
    var damageTypes = new List<SelectListItem>
{       new SelectListItem { Value = "", Text = "الكل " },
        new SelectListItem { Value = "جزئي", Text = "جزئي" },
        new SelectListItem { Value = "كلي", Text = "كلي" },
        new SelectListItem { Value = "ضرر طفيف", Text = "ضرر طفيف" },
        new SelectListItem { Value = "ضرر كبير", Text = "ضرر كبير" },
        new SelectListItem { Value = "تدمير كامل", Text = "تدمير كامل" },
        new SelectListItem { Value = "أخرى", Text = "أخرى" }
    };

    var governorates = new List<SelectListItem>
{         new SelectListItem { Value = "", Text = "الكل " },
        new SelectListItem { Value = "شمال غزة", Text = "شمال غزة" },
        new SelectListItem { Value = "مدينة غزة", Text = "مدينة غزة" },
        new SelectListItem { Value = "الوسطى", Text = "الوسطى" },
        new SelectListItem { Value = "خانيونس", Text = "خانيونس" },
        new SelectListItem { Value = "رفح", Text = "رفح" },
        new SelectListItem { Value = "الضفة الغربية", Text = "الضفة الغربية" },
        new SelectListItem { Value = "خارج البلاد", Text = "خارج البلاد" }
    };

    // تهيئة قائمة الأعمدة المتاحة
    var availableColumns = new List<LawyersSyndicatePortal.ViewModels.OfficeAndDamageReportViewModel.ReportColumn>
{
        new LawyersSyndicatePortal.ViewModels.OfficeAndDamageReportViewModel.ReportColumn { ColumnName = "LawyerIdNumber", DisplayName = "رقم الهوية / العضوية" , IsSelected = true },
        new LawyersSyndicatePortal.ViewModels.OfficeAndDamageReportViewModel.ReportColumn { ColumnName = "LawyerFullName", DisplayName = "الاسم الكامل للمحامي" , IsSelected = true },
        new LawyersSyndicatePortal.ViewModels.OfficeAndDamageReportViewModel.ReportColumn { ColumnName = "CurrentGovernorate", DisplayName = "المحافظة الحالية" , IsSelected = true },
        new LawyersSyndicatePortal.ViewModels.OfficeAndDamageReportViewModel.ReportColumn { ColumnName = "OriginalGovernorate", DisplayName = "المحافظة الأصلية" , IsSelected = true },
        new LawyersSyndicatePortal.ViewModels.OfficeAndDamageReportViewModel.ReportColumn { ColumnName = "OfficeAddress", DisplayName = "عنوان المكتب" , IsSelected = true },
        new LawyersSyndicatePortal.ViewModels.OfficeAndDamageReportViewModel.ReportColumn { ColumnName = "OfficeDamageType", DisplayName = "نوع ضرر المكتب" , IsSelected = true },
        new LawyersSyndicatePortal.ViewModels.OfficeAndDamageReportViewModel.ReportColumn { ColumnName = "OfficeDamageDetails", DisplayName = "تفاصيل ضرر المكتب" , IsSelected = true },
        new LawyersSyndicatePortal.ViewModels.OfficeAndDamageReportViewModel.ReportColumn { ColumnName = "HomeDamageType", DisplayName = "نوع ضرر المنزل" , IsSelected = true },
        new LawyersSyndicatePortal.ViewModels.OfficeAndDamageReportViewModel.ReportColumn { ColumnName = "HomeDamageDetails", DisplayName = "تفاصيل ضرر المنزل" , IsSelected = true }
    };
    Model.AvailableColumns = availableColumns;
}

<div class="container-fluid py-4">

    @* عنوان الصفحة الرئيسي *@
    <div class="row">
        <div class="col-12">
            <h2 class="text-primary mb-4 text-right" dir="rtl">
                <i class="fas fa-file-alt ml-2"></i> @ViewBag.Title
            </h2>
        </div>
    </div>

    @* لوحة البحث والمرشحات *@
    <div class="card shadow-sm mb-4" dir="rtl">
        <div class="card-header bg-white">
            <h5 class="card-title mb-0 text-right">
                <i class="fas fa-filter ml-2"></i> مرشحات البحث
            </h5>
        </div>
        <div class="card-body">
            @using (Html.BeginForm("Search", "OfficeAndDamageReports", FormMethod.Post, new { id = "searchForm", @class = "row g-3" }))
            {
                @Html.AntiForgeryToken()
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })

                @* حقول البحث *@
                <div class="col-md-6 col-lg-4">
                    <div class="form-group">
                        @Html.LabelFor(model => model.LawyerFullName, htmlAttributes: new { @class = "form-label" })
                        @Html.TextBoxFor(model => model.LawyerFullName, new { @class = "form-control text-right" })
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="form-group">
                        @Html.LabelFor(model => model.LawyerIdNumber, htmlAttributes: new { @class = "form-label" })
                        @Html.TextBoxFor(model => model.LawyerIdNumber, new { @class = "form-control text-right" })
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="form-group">
                        @Html.LabelFor(model => model.OfficeDamageType, htmlAttributes: new { @class = "form-label" })
                        @Html.DropDownListFor(model => model.OfficeDamageType, damageTypes, new { @class = "form-select text-right" })
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="form-group">
                        @Html.LabelFor(model => model.HomeDamageType, htmlAttributes: new { @class = "form-label" })
                        @Html.DropDownListFor(model => model.HomeDamageType, damageTypes, new { @class = "form-select text-right" })
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="form-group">
                        @Html.LabelFor(model => model.CurrentGovernorate, htmlAttributes: new { @class = "form-label" })
                        @Html.DropDownListFor(model => model.CurrentGovernorate, governorates, new { @class = "form-select text-right" })
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="form-group">
                        @Html.LabelFor(model => model.OriginalGovernorate, htmlAttributes: new { @class = "form-label" })
                        @Html.DropDownListFor(model => model.OriginalGovernorate, governorates, new { @class = "form-select text-right" })
                    </div>
                </div>

                @* اختيار الأعمدة *@
                <div class="col-12 mt-3">
                    <h6 class="text-right">
                        <i class="fas fa-columns ml-2"></i> اختر الأعمدة المراد عرضها في التقرير:
                    </h6>
                    <div class="row" id="columnsSelection">
                        @for (int i = 0; i < Model.AvailableColumns.Count; i++)
                        {
                            <div class="col-6 col-md-4 col-lg-2">
                                <div class="form-check form-switch form-check-inline text-right">
                                    @Html.CheckBoxFor(m => m.AvailableColumns[i].IsSelected, new { @class = "form-check-input", role = "switch", id = $"column-{i}" })
                                    @Html.HiddenFor(m => m.AvailableColumns[i].ColumnName)
                                    @Html.HiddenFor(m => m.AvailableColumns[i].DisplayName)
                                    <label class="form-check-label mr-2" for="column-@i">
                                        @Model.AvailableColumns[i].DisplayName
                                    </label>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                @* أزرار الإجراءات *@
                <div class="col-12 text-center mt-4">
                    <button type="submit" class="btn btn-primary" id="searchBtn">
                        <i class="fas fa-search ml-2"></i> بحث
                    </button>
                    <button type="button" class="btn btn-success" id="exportExcelBtn">
                        <i class="fas fa-file-excel ml-2"></i> تصدير إلى Excel
                    </button>
                    <button type="button" class="btn btn-secondary" id="clearBtn">
                        <i class="fas fa-eraser ml-2"></i> مسح الحقول
                    </button>
                </div>
            }
        </div>
    </div>



    @* حاوية عرض نتائج البحث *@
    <div id="reportResultsContainer">
        @* سيتم تحديث هذا الجزء ديناميكيًا عبر AJAX *@
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // معالجة زر "بحث" عبر AJAX
            $("#searchBtn").click(function (e) {
                e.preventDefault();
                var form = $("#searchForm");
                var url = form.attr("action");
                var requestData = form.serialize();

                $("#reportResultsContainer").html('<div class="text-center mt-5"><i class="fas fa-spinner fa-spin fa-3x text-primary"></i><h4 class="mt-3 text-secondary">جاري البحث...</h4></div>');

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: requestData,
                    success: function (result) {
                        $("#reportResultsContainer").html(result);
                    },
                    error: function (xhr, status, error) {
                        $("#reportResultsContainer").html('<div class="alert alert-danger text-center mt-5" role="alert"><i class="fas fa-exclamation-triangle ml-2"></i> حدث خطأ أثناء البحث. يرجى المحاولة مرة أخرى.</div>');
                        console.error("Error fetching search results:", error);
                    }
                });
            });

            // معالجة زر "تصدير إلى Excel"
            $("#exportExcelBtn").click(function () {
                var form = $("#searchForm");
                var exportUrl = '@Url.Action("ExportToExcel", "OfficeAndDamageReports")';

                // قم بتغيير الـ action والـ target للنموذج
                form.attr("action", exportUrl);
                form.attr("target", "_blank");

                // أرسل النموذج
                form.submit();

                // أعد الـ action إلى قيمته الأصلية
                form.attr("action", '@Url.Action("Search", "OfficeAndDamageReports")');
                form.removeAttr("target");
            });

            // معالجة زر "مسح الحقول"
            $("#clearBtn").click(function () {
                $("#searchForm")[0].reset();
                $("#columnsSelection input[type='checkbox']").prop('checked', false);
                $("#reportResultsContainer").empty();
            });
        });
    </script>
}
