@model LawyersSyndicatePortal.ViewModels.NewLawyerReportResultViewModel
@using System.Linq
@using LawyersSyndicatePortal.Models  
@using System.Web.Mvc.Html
@using System.Reflection

@*
    هذا هو الجزء (Partial View) المسؤول عن عرض نتائج التقرير في جدول.
    يتم تحديثه بشكل ديناميكي عبر AJAX.
*@

@if (Model != null && Model.Lawyers != null && Model.Lawyers.Any())
{
    @*
        الفرز الأبجدي حسب الاسم الكامل.
    *@
    @*
        تمت إضافة div "table-responsive" لجعل الجدول قابلاً للتمرير أفقياً
        عندما يكون عرضه أكبر من عرض الحاوية.
    *@
    <div class="table-responsive">
        <div class="report-table">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        @foreach (var column in Model.SelectedColumns)
                        {
                            <th>@column.DisplayName</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var lawyer in Model.Lawyers.OrderBy(l => l.FullName))
                    {
                        <tr>
                            @foreach (var column in Model.SelectedColumns)
                            {
                                <td>
                                    @{
                                        object value = null;
                                        string propertyPath = column.ColumnName;

                                        // منطق خاص للتعامل مع عمود "عدد الأبناء"
                                        if (propertyPath == "FamilyDetails.NumberOfChildren")
                                        {
                                            value = lawyer.FamilyDetails?.FirstOrDefault()?.Children?.Count ?? 0;
                                        }
                                        else
                                        {
                                            // استخدام Reflection للحصول على قيمة الخاصية
                                            var parts = propertyPath.Split('.');
                                            object currentObject = lawyer;
                                            PropertyInfo propertyInfo = null;

                                            foreach (var part in parts)
                                            {
                                                if (currentObject == null)
                                                {
                                                    break;
                                                }
                                                // للحصول على قيمة من ICollection مثل PersonalDetails أو FamilyDetails
                                                if (part == "PersonalDetails" || part == "FamilyDetails")
                                                {
                                                    var collection = currentObject.GetType().GetProperty(part)?.GetValue(currentObject, null) as IEnumerable<object>;
                                                    currentObject = collection?.FirstOrDefault();
                                                }
                                                else
                                                {
                                                    propertyInfo = currentObject.GetType().GetProperty(part);
                                                    currentObject = propertyInfo?.GetValue(currentObject, null);
                                                }
                                            }

                                            value = currentObject;
                                        }
                                    }

                                    @if (value != null)
                                    {
                                        // عرض "نعم" أو "لا" لقيم الخصائص المنطقية (Boolean)
                                        if (value is bool boolValue)
                                        {
                                            @(boolValue ? "نعم" : "لا")
                                        }
                                        else
                                        {
                                            @value.ToString()
                                        }
                                    }
                                    else
                                    {
                                        @:غير متوفر
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
else
{
    <div class="alert alert-info text-center mt-5" role="alert">
        <i class="fas fa-info-circle"></i> لا توجد نتائج مطابقة لمعايير البحث المحددة.
    </div>
}
