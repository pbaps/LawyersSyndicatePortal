@model LawyersSyndicatePortal.Models.ExamResult

@{
    ViewBag.Title = "تفاصيل النتيجة";
}

<div class="container py-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2 class="text-center text-primary">تفاصيل نتيجة الامتحان</h2>
            <hr />
        </div>
    </div>

    @if (Model == null)
    {
        <div class="alert alert-danger text-center" role="alert">
            النتيجة المطلوبة غير موجودة.
        </div>
    }
    else
    {
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title text-center text-primary">
                    <i class="fas fa-poll-h"></i>
                    @Html.DisplayFor(model => model.Exam.Title)
                </h5>
                <p class="card-text text-center">
                    <small class="text-muted">
                        المحامي: @Html.DisplayFor(model => model.Lawyer.FullName)
                    </small>
                </p>
                <div class="row">
                    <div class="col-md-6 text-center">
                        <strong>الدرجة النهائية:</strong>
                        <span>
                            @Html.DisplayFor(model => model.TotalScoreAchieved) من @Html.DisplayFor(model => model.TotalExamScore)
                        </span>
                    </div>
                    <div class="col-md-6 text-center">
                        <strong>حالة التصحيح:</strong>
                        @if (Model.IsGradingComplete)
                        {
                            <span class="badge badge-success">تم التصحيح</span>
                        }
                        else
                        {
                            <span class="badge badge-warning">قيد التصحيح</span>
                        }
                    </div>
                </div>
            </div>
        </div>

        foreach (var answer in Model.ExamAttendee.Answers.OrderBy(a => a.QuestionId))
        {
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-light">
                    <strong>
                        السؤال:
                        <small>(@(answer.Question.Score) درجة)</small>
                    </strong>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        <strong>نص السؤال:</strong>
                        @Html.Raw(answer.Question.Text)
                    </p>
                    <hr />
                    <p class="card-text">
                        <strong>إجابة المحامي:</strong>
                        @Html.Raw(answer.UserAnswer)
                    </p>

                    @if (answer.Question.RequiresManualGrading)
                    {
                        @Html.Partial("_GradeTextQuestionPartial", answer)
                    }
                    else
                    {
                        <p class="card-text">
                            <strong>الدرجة التي حصل عليها:</strong>
                            <span class="@(answer.IsCorrect ? "text-success" : "text-danger")">
                                @(answer.AcquiredScore ?? 0) من @(answer.Question.Score)
                            </span>
                        </p>
                    }
                </div>
            </div>
        }
    }
</div>

@section Scripts {
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        $(document).ready(function () {
            // Function to handle grading via AJAX
            function gradeQuestion(answerId, questionScore) {
                var url = "@Url.Action("GradeTextQuestion", "ExamResults")";
                $.ajax({
                    url: url,
                    type: "POST",
                    data: {
                        answerId: answerId,
                        questionScore: questionScore
                    },
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            location.reload(); // Reload the page to show the updated score
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert("An unexpected error occurred: " + error);
                    }
                });
            }

            // Event listener for the "Grade" button
            $(document).on("click", ".grade-btn", function () {
                var answerId = $(this).data("answer-id");
                var questionScore = $(`#scoreInput_${answerId}`).val();
                if (questionScore === "") {
                    alert("Please enter a score for the question.");
                    return;
                }
                gradeQuestion(answerId, parseFloat(questionScore));
            });
        });
    </script>
}
