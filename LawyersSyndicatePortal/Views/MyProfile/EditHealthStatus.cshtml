@model LawyersSyndicatePortal.ViewModels.HealthStatusViewModel

@{
    ViewBag.Title = "تعديل الحالة الصحية";
    Layout = "~/Views/Shared/_UserLayout.cshtml";
}

<div class="dashboard-wrapper">
    <h2 class="page-title">
        تعديل الحالة الصحية
    </h2>

    @* Success and Error Messages Section *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert-card-glow alert-success-glow mb-4" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert-card-glow alert-danger-glow mb-4" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="card-lux">
        <div class="card-header-lux">
            <h5 class="card-title-lux mb-0"><i class="fas fa-heartbeat me-2"></i>تعديل الحالة الصحية</h5>
        </div>
        <div class="card-body-lux">
            @using (Html.BeginForm("EditHealthStatus", "MyProfile", FormMethod.Post, new { @class = "row g-3" }))
            {
                @Html.AntiForgeryToken()
                @Html.ValidationSummary(true, "", new { @class = "text-danger col-12" })
                @Html.HiddenFor(model => model.Id)

                <div class="col-md-6">
                    <label for="LawyerCondition" class="form-label control-label">@Html.DisplayNameFor(model => model.LawyerCondition)</label>
                    @Html.DropDownListFor(model => model.LawyerCondition, Model.LawyerConditions, "الرجاء الاختيار", new { @class = "form-control", id = "lawyerCondition" })
                    @Html.ValidationMessageFor(model => model.LawyerCondition, "", new { @class = "text-danger" })
                </div>

                <div id="lawyerInjuryDetails" class="col-12" style="@(Model.LawyerCondition == "Injured" || Model.LawyerCondition == "NeedsTreatment" ? "" : "display:none;")">
                    <div class="card-lux mt-3">
                        <div class="card-header-lux">
                            <h5 class="card-title-lux mb-0"><i class="fas fa-stethoscope me-2"></i>تفاصيل الإصابة</h5>
                        </div>
                        <div class="card-body-lux">
                            <div class="form-group row g-3">
                                <label for="InjuryDetails" class="form-label control-label">@Html.DisplayNameFor(model => model.InjuryDetails)</label>
                                <div class="col-12">
                                    @Html.TextAreaFor(model => model.InjuryDetails, new { @class = "form-control", rows = 3 })
                                    @Html.ValidationMessageFor(model => model.InjuryDetails, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="lawyerTreatmentNeeded" class="col-12" style="@(Model.LawyerCondition == "NeedsTreatment" ? "" : "display:none;")">
                    <div class="card-lux mt-3">
                        <div class="card-header-lux">
                            <h5 class="card-title-lux mb-0"><i class="fas fa-pills me-2"></i>تفاصيل العلاج المطلوب</h5>
                        </div>
                        <div class="card-body-lux">
                            <div class="form-group row g-3">
                                <label for="TreatmentNeeded" class="form-label control-label">@Html.DisplayNameFor(model => model.TreatmentNeeded)</label>
                                <div class="col-12">
                                    @Html.TextAreaFor(model => model.TreatmentNeeded, new { @class = "form-control", rows = 3 })
                                    @Html.ValidationMessageFor(model => model.TreatmentNeeded, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="lawyerDiagnosisSection" class="col-12" style="@(Model.LawyerCondition == "Healthy" ? "display:none;" : "")">
                    <div class="card-lux mt-3">
                        <div class="card-header-lux">
                            <h5 class="card-title-lux mb-0"><i class="fas fa-diagnoses me-2"></i>التشخيص الطبي</h5>
                        </div>
                        <div class="card-body-lux">
                            <div class="form-group row g-3">
                                <label for="LawyerDiagnosis" class="form-label control-label">@Html.DisplayNameFor(model => model.LawyerDiagnosis)</label>
                                <div class="col-12">
                                    @Html.TextAreaFor(model => model.LawyerDiagnosis, new { @class = "form-control", rows = 3 })
                                    @Html.ValidationMessageFor(model => model.LawyerDiagnosis, "", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-4 mt-4">
                    <div class="form-check form-switch">
                        @Html.EditorFor(model => model.HasFamilyMembersInjured, new { htmlAttributes = new { @class = "form-check-input", id = "hasFamilyMembersInjured" } })
                        <label for="hasFamilyMembersInjured" class="form-check-label control-label">@Html.DisplayNameFor(model => model.HasFamilyMembersInjured)</label>
                        @Html.ValidationMessageFor(model => model.HasFamilyMembersInjured, "", new { @class = "text-danger" })
                    </div>
                </div>

                <div id="familyMembersInjuredSection" class="col-12" style="@(Model.HasFamilyMembersInjured ? "" : "display:none;")">
                    <div class="card-lux mt-3">
                        <div class="card-header-lux">
                            <h5 class="card-title-lux mb-0"><i class="fas fa-users me-2"></i>تفاصيل أفراد العائلة المصابين</h5>
                        </div>
                        <div class="card-body-lux">
                            <div class="form-group row mb-3">
                                <label for="NumberOfFamilyMembersInjured" class="form-label control-label col-md-2">@Html.DisplayNameFor(model => model.NumberOfFamilyMembersInjured)</label>
                                <div class="col-md-10">
                                    @Html.EditorFor(model => model.NumberOfFamilyMembersInjured, new { htmlAttributes = new { @class = "form-control", type = "number", min = "0", max = "50", id = "numberOfFamilyMembersInjured" } })
                                    @Html.ValidationMessageFor(model => model.NumberOfFamilyMembersInjured, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div id="injuredFamilyMembersContainer">
                                @if (Model.FamilyMemberInjuries != null)
                                {
                                    for (int i = 0; i < Model.FamilyMemberInjuries.Count; i++)
                                    {
                                        @Html.Partial("_FamilyMemberInjuryFields", Model.FamilyMemberInjuries[i], new ViewDataDictionary { { "index", i } })
                                    }
                                }
                            </div>
                            <div class="text-end mt-3">
                                <button type="button" id="addFamilyMemberInjury" class="btn btn-outline-primary btn-sm"><i class="fas fa-plus-circle me-2"></i>إضافة فرد عائلة مصاب</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg me-2"><i class="fas fa-save me-2"></i>حفظ</button>
                    @Html.ActionLink("العودة", "Index", "MyProfile", null, new { @class = "btn btn-outline-secondary btn-lg" })
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        $(document).ready(function () {
            // Function to update element names/ids based on index
            function updateElementNames(container, prefix) {
                $(container).find('.dynamic-item').each(function (index) {
                    $(this).find('.card-header h5').text('تفاصيل المصاب رقم ' + (index + 1));
                    $(this).find(':input').each(function () {
                        var name = $(this).attr('name');
                        if (name) {
                            name = name.replace(/\[\d+\]/, '[' + index + ']');
                            $(this).attr('name', name);
                        }
                        var id = $(this).attr('id');
                        if (id) {
                            id = id.replace(/_\d+__/, '_' + index + '__');
                            $(this).attr('id', id);
                        }
                    });
                    // Update hidden Id field for existing items
                    $(this).find('input[type="hidden"][name$=".Id"]').attr('name', prefix + '[' + index + '].Id');
                });
            }

            // Toggle visibility based on LawyerCondition
            $('#lawyerCondition').change(function () {
                var condition = $(this).val();

                if (condition === 'Injured' || condition === 'NeedsTreatment') {
                    $('#lawyerInjuryDetails').show();
                } else {
                    $('#lawyerInjuryDetails').hide();
                    $('#InjuryDetails').val('');
                }

                if (condition === 'NeedsTreatment') {
                    $('#lawyerTreatmentNeeded').show();
                } else {
                    $('#lawyerTreatmentNeeded').hide();
                    $('#TreatmentNeeded').val('');
                }

                if (condition === 'Healthy') {
                    $('#lawyerDiagnosisSection').hide();
                    $('#LawyerDiagnosis').val('');
                } else {
                    $('#lawyerDiagnosisSection').show();
                }
            }).change();

            // Toggle family members injured section visibility
            $('#hasFamilyMembersInjured').change(function () {
                if ($(this).is(':checked')) {
                    $('#familyMembersInjuredSection').show();
                } else {
                    $('#familyMembersInjuredSection').hide();
                    $('#numberOfFamilyMembersInjured').val(0);
                    $('#injuredFamilyMembersContainer').empty();
                }
            }).change();

            // Add Family Member Injury field
            $('#addFamilyMemberInjury').click(function () {
                var newIndex = $('#injuredFamilyMembersContainer .dynamic-item').length;
                $.ajax({
                    url: '@Url.Action("AddFamilyMemberInjuryField", "MyProfile")',
                    type: 'POST',
                    data: { index: newIndex },
                    success: function (partialView) {
                        $('#injuredFamilyMembersContainer').append(partialView);
                        updateElementNames('#injuredFamilyMembersContainer', 'FamilyMemberInjuries');
                        $.validator.unobtrusive.parse($('#injuredFamilyMembersContainer'));
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX Error (AddFamilyMemberInjuryField):", status, error);
                        console.error("Response Text (AddFamilyMemberInjuryField):", xhr.responseText);
                    }
                });
            });

            // Remove Family Member Injury field
            $(document).on('click', '.removeFamilyMemberInjury', function () {
                $(this).closest('.dynamic-item').remove();
                updateElementNames('#injuredFamilyMembersContainer', 'FamilyMemberInjuries');
            });

            // Initial update of names/ids on page load for existing items
            updateElementNames('#injuredFamilyMembersContainer', 'FamilyMemberInjuries');

            // Initialize datepicker for date fields
            $('.datepicker').datepicker({
                dateFormat: 'yy-mm-dd',
                autoclose: true,
                todayHighlight: true
            });
        });
    </script>
}