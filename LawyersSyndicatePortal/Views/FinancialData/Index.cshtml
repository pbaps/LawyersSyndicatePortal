@model LawyersSyndicatePortal.ViewModels.FinancialDataReportViewModel
@{
    ViewBag.Title = "تقارير البيانات المالية";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<h2 class="text-right">تقارير البيانات المالية</h2>
<hr />

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show text-right" role="alert" dir="rtl">
        <strong>نجاح!</strong> @TempData["SuccessMessage"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show text-right" role="alert" dir="rtl">
        <strong>خطأ!</strong> @TempData["ErrorMessage"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}

<div class="card mb-4" dir="rtl">
    <div class="card-header bg-primary text-white text-right">
        <i class="fas fa-search"></i> خيارات البحث
    </div>
    <div class="card-body">
        <form id="searchForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group text-right">
                        @Html.LabelFor(model => model.FullName, new { @class = "control-label" })
                        @Html.TextBoxFor(model => model.FullName, new { @class = "form-control text-right", placeholder = "الاسم الكامل أو جزء منه" })
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="IdNumber" class="form-label">رقم الهوية</label>
                    @Html.TextBoxFor(model => model.IdNumber, new { @class = "form-control", placeholder = "ادخل رقم الهوية" })
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group text-right">
                        @Html.LabelFor(model => model.MembershipNumber, new { @class = "control-label" })
                        @Html.TextBoxFor(model => model.MembershipNumber, new { @class = "form-control text-right", placeholder = "ادخل رقم العضوية" })
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group text-right">
                        @Html.LabelFor(model => model.BankName, new { @class = "control-label" })
                        @Html.DropDownListFor(model => model.BankName, Model.BankList, new { @class = "form-control text-right" })
                    </div>
                </div>
            </div>

            <div class="form-group text-right mt-3">
                <button type="submit" id="searchBtn" class="btn btn-primary">
                    <i class="fas fa-search"></i> بحث
                </button>
                <button type="button" id="clearBtn" class="btn btn-secondary">
                    <i class="fas fa-undo"></i> مسح الحقول
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card mb-4 shadow-sm" dir="rtl">
    <div class="card-header text-white text-right">
        <h5 class="mb-0"><i class="fas fa-columns me-2"></i> اختيار الأعمدة في التقرير</h5>
    </div>
    <div class="card-body">
        <form id="columnsSelection">
            <div class="row">
                @for (int i = 0; i < Model.AvailableColumns.Count; i++)
                {
                    <div class="col-md-6 col-lg-4 mb-2">
                        <div class="form-check form-switch d-flex justify-content-between align-items-center">
                            <label class="form-check-label text-right" for="AvailableColumns_@(i)__IsSelected">
                                @Model.AvailableColumns[i].DisplayName
                            </label>
                            @Html.CheckBoxFor(m => m.AvailableColumns[i].IsSelected, new { @class = "form-check-input", role = "switch" })
                            @Html.HiddenFor(m => m.AvailableColumns[i].ColumnName)
                            @Html.HiddenFor(m => m.AvailableColumns[i].DisplayName)
                        </div>
                    </div>
                }
            </div>
        </form>
    </div>
</div>

<div class="text-right mb-3" dir="rtl">
    <button type="button" id="exportExcelBtn" class="btn btn-success">
        <i class="fas fa-file-excel"></i> تصدير إلى Excel
    </button>
</div>

<div id="reportResultsContainer" class="mt-4">
    @* يتم عرض Partial View هنا *@
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        $(document).ready(function () {
            $("#searchBtn").click(function (e) {
                e.preventDefault();
                $("#reportResultsContainer").html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i></div>');
                var requestData = $("#searchForm, #columnsSelection").serialize();

                $.ajax({
                    url: "@Url.Action("Search", "FinancialData")",
                    type: "POST",
                    data: requestData,
                    success: function (result) {
                        $("#reportResultsContainer").html(result);
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX Error: " + error);
                        $("#reportResultsContainer").html('<div class="alert alert-danger text-center" dir="rtl">حدث خطأ أثناء تحميل البيانات.</div>');
                    }
                });
            });

            $("#exportExcelBtn").click(function () {
                var form = $('<form action="@Url.Action("ExportToExcel", "FinancialData")" method="post"></form>');
                var dataArray = $("#searchForm, #columnsSelection").serializeArray();
                $.each(dataArray, function (index, item) {
                    form.append($('<input type="hidden">').attr('name', item.name).val(item.value));
                });
                $('body').append(form);
                form.submit();
                form.remove();
            });

            $("#clearBtn").click(function () {
                $("#searchForm")[0].reset();
                $("#searchForm select").each(function () {
                    $(this).val($(this).find("option:first").val());
                });
                $("#reportResultsContainer").empty();
            });
        });
    </script>
}