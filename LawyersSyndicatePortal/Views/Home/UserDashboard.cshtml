@model LawyersSyndicatePortal.ViewModels.UserDashboardViewModel
@using Microsoft.AspNet.Identity
@using System.Linq
@using System

@{
    ViewBag.Title = "لوحة تحكم المستخدم";
    Layout = "~/Views/Shared/_UserLayout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;800&display=swap" rel="stylesheet">


<div class="dashboard-wrapper">
    <h2 class="page-title">لوحة تحكم المستخدم</h2>

    @if (Model.AvailableExams != null && Model.AvailableExams.Any())
    {
        <div class="alert-card-glow alert alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>إشعار عاجل:</strong> لديك اختبار متاح الآن!
            <a href="@Url.Action("/Index", "ExamTaker")">انقر هنا لبدء الاختبار.</a>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (Model.RecentBroadcasts != null && Model.RecentBroadcasts.Any())
    {
        foreach (var broadcast in Model.RecentBroadcasts)
        {
            <div id="broadcastAlert_@broadcast.Id"
                 class="alert-card-glow alert alert-dismissible fade show"
                 data-sent-date="@broadcast.SentDate.ToString("yyyy-MM-dd HH:mm:ss")">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-bullhorn me-2"></i>
                        <strong>تعميم جديد!</strong>
                        <span class="d-none d-md-inline"> - @broadcast.Subject</span>
                    </div>
                    <div>
                        <a data-bs-toggle="collapse" href="#broadcastDetails_@broadcast.Id" role="button" aria-expanded="false" aria-controls="broadcastDetails_@broadcast.Id" class="btn btn-sm btn-outline-light ms-2">
                            عرض التفاصيل
                        </a>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
                <div class="collapse" id="broadcastDetails_@broadcast.Id">
                    <hr />
                    <h5 class="mb-2">@broadcast.Subject</h5>
                    <p class="mb-0">@broadcast.SentDate.ToString("yyyy-MM-dd HH:mm")</p>
                    <a href="@Url.Action("Details", "Messages", new { id = broadcast.Id, type = "broadcast" })" class="btn btn-sm btn-link mt-2 p-0" style="color: inherit; text-decoration: underline;">
                        قراءة المزيد
                    </a>
                </div>
            </div>
        }
    }

    <div class="welcome-card-lux">
        <h1>أهلاً بك، @Model.User.FullName!</h1>
        <p class="lead">من هنا يمكنك الوصول إلى جميع خدماتك الخاصة وإدارة حسابك بسهولة.</p>
        <a href="@Url.Action("Index", "MyProfile")" class="btn-profile-highlight">
            <i class="fas fa-user-circle me-2"></i> تعديل ملفي الشخصي
        </a>
    </div>

    <div class="action-grid">
        <div class="action-card">
            <h3><i class="fas fa-id-card"></i> معلومات حسابي</h3>
            <p>استعرض تفاصيل حسابك الأساسية ومعلوماتك الشخصية.</p>
            <a href="@Url.Action("ViewMyCV", "LawyerCV")" class="btn">
                <i class="fas fa-eye me-2"></i> عرض الملف الشخصي
            </a>
        </div>

        <div class="action-card">
            <h3><i class="fas fa-envelope"></i> رسائلي</h3>
            <p>إدارة رسائلك والاطلاع على التعميمات والإعلانات.</p>
            <div class="mt-auto d-grid gap-2">
                <a href="@Url.Action("Inbox", "Messages")" class="btn btn-block">
                    <i class="fas fa-inbox me-2"></i> صندوق الوارد
                </a>
                <a href="@Url.Action("ComposeToAdmin", "Messages")" class="btn btn-block">
                    <i class="fas fa-edit me-2"></i> إرسال رسالة للإدارة
                </a>
            </div>
        </div>

        <div class="action-card">
            <h3><i class="fas fa-file-alt"></i> الاختبارات المتاحة</h3>
            @if (Model.AvailableExams != null && Model.AvailableExams.Any())
            {
                <p>لديك اختبارات متاحة يمكنك البدء بها الآن.</p>
                <a href="@Url.Action("/Index", "ExamTaker")" class="btn">
                    <i class="fas fa-play-circle me-2"></i> بدء الاختبارات
                </a>
            }
            else
            {
                <p class="text-muted">لا توجد اختبارات متاحة لك حالياً.</p>
                <button class="btn btn-disabled">
                    <i class="fas fa-ban me-2"></i> لا توجد اختبارات
                </button>
            }
        </div>

        <div class="action-card">
            <h3><i class="fas fa-history"></i> اختبارات سابقة</h3>
            <p>استعراض الاختبارات التي أجريتها والنتائج الخاصة بها.</p>
            <a href="@Url.Action("/Index", "ExamTaker")" class="btn">
                <i class="fas fa-eye me-2"></i> عرض الاختبارات السابقة
            </a>
        </div>
    </div>
</div>

@section scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const now = new Date();
            const alerts = document.querySelectorAll('.alert-card-glow[data-sent-date]');
            const millisecondsIn24Hours = 24 * 60 * 60 * 1000;

            alerts.forEach(alert => {
                const sentDateString = alert.dataset.sentDate;
                if (sentDateString) {
                    const sentDate = new Date(sentDateString);
                    const timeDifference = now - sentDate;

                    if (timeDifference > millisecondsIn24Hours) {
                        // إخفاء الإشعار إذا مر عليه أكثر من 24 ساعة
                        alert.classList.add('d-none');
                    }
                }
            });
        });
    </script>
}